#This file holds the Bosun alert rules, macros, notifications, lookups, and templates. It should be edited from the Rule Editor page.

template wise2c.test {
    subject = `
        {
            "Summary": "{{ .Alert.Name }}",
            "SourceAlertKey": "交易量",
            "SourceSeverity": "Critical",
            "SourceIdentifier": "Identifier",
            "SourceEventID": "1455867577750",
            "Severity": "{{ if eq (print .Alert.Warn) .Result.Expr }}1{{ else }}3{{ end }}",
            "LastOccurrence": {{.Start}},
            "SourceCIName": "192.168.123.191",
            "Status": 1,
            "SourceID": 10
        }
    `
}

#notification wise2c.json{
#    post = http://fluentd:8080
#    body = json={"subject":"{{.}}"}
#}

#alert wise2c.alert {
#    template = wise2c.test
#    $q = avg(q("sum:rate:container.cpu{stack=*}", "1h", ""))
#    crit = $q > 1000
#    critNotification = wise2c.json
#    warn = $q <= 1000
#    warnNotification = wise2c.json
#}

notification default {
	email = langer.markus@gmail.com
	print = true
    #timeout = 1d
}

template ut {
    subject = {{.Name}}: {{.Group | len}} unknown alerts
        body = `
            <p>Time: {{.Time}}
            <p>Name: {{.Name}}
            <p>Alerts:
            {{range .Group}}
            <br>{{.}}
    {{end}}`
}

unknownTemplate = ut

template generic {
	body = `<a href="{{.Ack}}">Acknowledge alert</a>
	<p>Alert definition:
	<p>Name: {{.Alert.Name}}
	<p>Crit: {{.Alert.Crit}}
	<p>Tags
	<table>
		{{range $k, $v := .Group}}
			{{if eq $k "host"}}
				<tr><td>{{$k}}</td><td><a href="{{$.HostView $v}}">{{$v}}</a></td></tr>
			{{else}}
				<tr><td>{{$k}}</td><td>{{$v}}</td></tr>
			{{end}}
		{{end}}
	</table>

	<p>Computation
	<table>
		{{range .Computations}}
			<tr><td>{{.Text}}</td><td>{{.Value}}</td></tr>
		{{end}}
	</table>`
	subject = {{.Last.Status}}: {{.Alert.Name}}: {{.Eval .Alert.Vars.q}} on {{.Group.host}}
}

template name {
	body = Name: {{.Alert.Name}}
}
template ex {
	body = `Alert definition:
	{{template "name" .}}
	Crit: {{.Alert.Crit}}

	Tags:{{range $k, $v := .Group}}
	{{$k}}: {{$v}}{{end}}
	`
	subject = {{.Alert.Name}}: {{.Eval .Alert.Vars.q }} on {{.Group.host}}
}

alert cpu_system.is.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_system{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_guest.is.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_guest{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

#alert cpu_idle.is.too.low {
#	template = ex
#	$metric = q("sum:telegraf.cpu_usage_idle{host=*,cpu=cpu-total}", "1h", "")
#	$q = avg($metric)
#	crit = $q > 10
#	warn = $q > 20
#}

alert cpu_irq.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_irq{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_softirq.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_softirq{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_guest_nice.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_guest_nice{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_iowait.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_iowait{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_nice.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_nice{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_steal.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_steal{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_user.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_user{host=*,cpu=cpu-total}", "1h", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert load1 {
    template = generic
    $metric = q("sum:telegraf.system_load1{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > 5
    warn = $q > 4
	warnNotification = default
	critNotification = default
}

alert load5 {
    template = generic
    $metric = q("sum:telegraf.system_load5{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > 4
    warn = $q > 3
	warnNotification = default
	critNotification = default
}

alert load15 {
    template = generic
    $metric = q("sum:telegraf.system_load15{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > 3
    warn = $q > 2
	warnNotification = default
	critNotification = default
}
