####################

#############
# templates #
#############

#template logstash {
#    subject = `
#        {
#            "Summary": "{{ .Alert.Name }}",
#            "SourceAlertKey": "Bosun",
#            "SourceSeverity": "Critical",
#            "SourceIdentifier": "Identifier",
#            "SourceEventID": "1455867577750",
#            "Severity": "{{ if eq (print .Alert.Warn) .Result.Expr }}1{{ else }}3{{ end }}",
#            "LastOccurrence": {{.Start}},
#            "SourceCIName": "server.langer.lan",
#            "Status": 1,
#            "SourceID": 10
#        }
#    `
#}

#notification logstash{
#    post = http://logstash:8080
#    body = json={"subject":"{{.}}"}
#}

#alert logstash.alert {
#    template = logstash
#    $q = avg(q("sum:rate:container.cpu{stack=*}", "1h", ""))
#    crit = $q > 1000
#    critNotification = logstash
#    warn = $q <= 1000
#    warnNotification = logstash
#}

notification default {
	email = langer.markus@gmail.com
	print = true
    #timeout = 1d
}

template ut {
    subject = {{.Name}}: {{.Group | len}} unknown alerts
        body = `
            <p>Time: {{.Time}}
            <p>Name: {{.Name}}
            <p>Alerts:
            {{range .Group}}
            <br>{{.}}
    {{end}}`
}

unknownTemplate = ut

template generic {
	body = `<a href="{{.Ack}}">Acknowledge alert</a>
	<p>Alert definition:
	<p>Name: {{.Alert.Name}}
	<p>Crit: {{.Alert.Crit}}
	<p>Tags
	<table>
		{{range $k, $v := .Group}}
			{{if eq $k "host"}}
				<tr><td>{{$k}}</td><td><a href="{{$.HostView $v}}">{{$v}}</a></td></tr>
			{{else}}
				<tr><td>{{$k}}</td><td>{{$v}}</td></tr>
			{{end}}
		{{end}}
	</table>

	<p>Computation
	<table>
		{{range .Computations}}
			<tr><td>{{.Text}}</td><td>{{.Value}}</td></tr>
		{{end}}
	</table>
	</br>
	{{.Graph .Alert.Vars.metric}}`
	subject = {{.Last.Status}}: {{.Alert.Name}}: {{.Eval .Alert.Vars.q}} on {{.Group.host}}
}

template name {
	body = Name: {{.Alert.Name}}
}

template ex {
	body = `Alert definition:
	{{template "name" .}}
	Crit: {{.Alert.Crit}}

	Tags:{{range $k, $v := .Group}}
	{{$k}}: {{$v}}{{end}}
	{{.Graph .Alert.Vars.metric}}
	`
	subject = {{.Alert.Name}}: {{.Eval .Alert.Vars.q }} on {{.Group.host}}
}

##############
# mem_checks #
##############

#telegraf.mem_active
#telegraf.mem_available
#telegraf.mem_buffered
#telegraf.mem_cached
#telegraf.mem_free
#telegraf.mem_inactive
#telegraf.mem_total
#telegraf.mem_used
#telegraf.mem_used_percent
#telegraf.mem_available_percent

alert unix.memory {
	template = ex
	$metric = q("sum:telegraf.mem_used_percent{host=*}", "1h", "")
	$q = avg($metric)
	crit = $q > 98
	warn = $q > 96
    warnNotification = default
    critNotification = default
}

##############
# cpu_checks #
##############

alert cpu_system.is.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_system{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_guest.is.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_guest{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_idle.is.too.low {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_idle{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q < 20
	warn = $q < 40
}

alert cpu_irq.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_irq{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_softirq.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_softirq{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_guest_nice.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_guest_nice{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
    warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_iowait.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_iowait{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_nice.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_nice{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_steal.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_steal{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

alert cpu_user.too.high {
	template = ex
	$metric = q("sum:telegraf.cpu_usage_user{host=*,cpu=cpu-total}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 60
    warnNotification = default
    critNotification = default
}

###############
# load checks #
###############

alert unix_load_short {
    template = generic
    $cpus = avg(q("sum:telegraf.system_n_cpus{host=*}", "5m", ""))
    $metric = q("sum:telegraf.system_load1{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > ($cpus * 2)
    warn = $q > ($cpus * 1.9)
	warnNotification = default
	critNotification = default
}

alert unix_load_middle {
    template = generic
    $cpus = avg(q("sum:telegraf.system_n_cpus{host=*}", "5m", ""))
    $metric = q("sum:telegraf.system_load5{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > ($cpus * 1.4)
    warn = $q > ($cpus * 1.3)
	warnNotification = default
	critNotification = default
}

alert unix_load_long {
    template = generic
    $cpus = avg(q("sum:telegraf.system_n_cpus{host=*}", "5m", ""))
    $metric = q("sum:telegraf.system_load15{host=*}", "5m", "")
    $q = avg($metric)
    crit = $q > ($cpus * 1.3)
    warn = $q > ($cpus * 1.2)
	warnNotification = default
	critNotification = default
}

################
# cisco checks #
################

alert cisco.cpu_short {
	template = ex
	$metric = q("sum:telegraf.snmp_cpmCPUTotal5sec{host=*}", "5m", "")
	$q = avg($metric)
	crit = $q > 80
	warn = $q > 70
    warnNotification = default
    critNotification = default
}

alert cisco.cpu_middle {
	template = ex
	$metric = q("sum:telegraf.snmp_cpmCPUTotal1min{host=*}", "5m", "")
	$q = avg($metric)
	crit = $q > 65
	warn = $q > 55
    warnNotification = default
    critNotification = default
}

alert cisco.cpu_long {
	template = ex
	$metric = q("sum:telegraf.snmp_cpmCPUTotal1min{host=*}", "5m", "")
	$q = avg($metric)
	crit = $q > 40
	warn = $q > 35
    warnNotification = default
    critNotification = default
}

############
# hardware #
############

template hardware {
    body = `
    <style>
    table {
        border-collapse: collapse;
    }
    th,td {
        text-align: left;
        padding-right: 8px;
    }
    </style>
    <p>Overall System status is  {{if gt .Value 1.0}} <span style="color: red;">Bad</span>
              {{else}} <span style="color: green;">Ok</span>
              {{end}}</p>
    
    <h3>Power Supplies</h3>
    <table>
    <tr><th>Power Supply Name:</th><th>Status:</th><th>Watt:</th></tr>
    {{ range $r := .LeftJoin .Alert.Vars.power .Alert.Vars.power_val }}
    	{{ $power     := index $r 0 }}
		{{ $power_val := index $r 1 }}
            <tr>
              <td>{{$power.Group.name}}</td>
              {{if lt $power.Value 1.0}} <td style="color: red;">Bad</td>
              {{else}} <td style="color: green;">Ok</td>
              {{end}}
              <td>{{$power_val.Value}}</td>
            </tr>
    {{end}}
    </table>
    
    <h3>Fan Blocks</h3>
    <table>
    <tr><th>Fan Blocks Name</th><th>Status</th></tr>
    {{range $r := .EvalAll .Alert.Vars.fanblocks}}
        {{if eq $r.Group.host $.Group.host}}
            <tr>
              <td>{{$r.Group.name}}</td>
              {{if lt $r.Value 1.0}} <td style="color: red;">Bad</td>
              {{else}} <td style="color: green;">Ok</td>
              {{end}}
            </tr>
        {{end}}
    {{end}}
    </table>
    
    <h3>Temp Sensors</h3>
    <table>
    <tr><th>Temp Sensor Name</th><th>Status</th><th>Temp:</th></tr>
    {{ range $r := .LeftJoin .Alert.Vars.temp .Alert.Vars.temp_val }}
    	{{ $temp     := index $r 0 }}
		{{ $temp_val := index $r 1 }}
            <tr>
              <td>{{$temp.Group.name}}</td>
              {{if lt $temp.Value 1.0}} <td style="color: red;">Bad</td>
              {{else}} <td style="color: green;">Ok</td>
              {{end}}
              <td>{{$temp_val.Value}}</td>
            </tr>
    {{end}}
    </table>

    <h3>Controller</h3>
    <table>
    <tr><th>Controller Name</th><th>Status</th></tr>
    {{range $r := .EvalAll .Alert.Vars.controllerbay}}
      {{if eq $r.Group.host $.Group.host}}
            <tr>
              <td>{{$r.Group.name}}</td>
              {{if lt $r.Value 1.0}} <td style="color: red;">Bad</td>
              {{else}} <td style="color: green;">Ok</td>
              {{end}}
            </tr>
        {{end}}
    {{end}}
    </table>
    `
    subject = {{.Last.Status}}: {{replace .Alert.Name "." " " -1}}: on {{.Group.host}}
}


alert hardware {
    template = hardware
    $time = "30m"
    #By Component
    $power         = avg(q("sum:telegraf.ipmi_sensor_status{host=*,name=power_supply_*}", $time, ""))
    $power_val     = avg(q("sum:telegraf.ipmi_sensor_value{host=*,name=power_supply_*}", $time, ""))
    $fanblocks     = avg(q("sum:telegraf.ipmi_sensor_status{host=*,name=fan_block_*}", $time, ""))
    $temp          = avg(q("sum:telegraf.ipmi_sensor_status{host=*,name=temp_*}", $time, ""))
    $temp_val      = avg(q("sum:telegraf.ipmi_sensor_value{host=*,name=temp_*}", $time, ""))
    $controllerbay = avg(q("sum:telegraf.ipmi_sensor_status{host=*,name=cntlr_*}", $time, ""))
    $system        = avg(q("sum:telegraf.ipmi_sensor_status{host=*,name=*}", $time, ""))
    #Component Summary Per Host
    $s_power= sum(t($power, "host"))
    $s_fanblocks = sum(t($fanblocks, "host"))
    
    warn = $system < 1
}